name: CLI Release

on:
    push:
        tags: ["release-cli-*"]

jobs:
    test:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./cli
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go 1.24.12
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24.12"

            - name: Verify Go version
              run: go version

            - name: Setup dependencies
              run: make setup

            - name: Run tests
              run: make test

    lint:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./cli
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go 1.24.12
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24.12"

            - name: Verify Go version
              run: go version

            - name: Setup dependencies
              run: make setup

            - name: Install golangci-lint
              run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.5

            - name: Run lint
              run: make lint

    build:
        runs-on: ubuntu-latest
        environment: release-cli
        needs: [test, lint]
        permissions:
            contents: write
            packages: write
        defaults:
            run:
                working-directory: ./cli
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set version from tag
              id: version
              run: |
                  echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
                  echo "VERSION=${GITHUB_REF_NAME#release-cli-}" >> $GITHUB_OUTPUT

            - name: Set up Go 1.24.12
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24.12"

            - name: Verify Go version
              run: go version

            - name: Setup dependencies
              run: make setup

            - name: Create Psiphon config
              run: printf '%s' "$PSIPHON_CONFIG_JSON" > psiphon_config.json
              env:
                  PSIPHON_CONFIG_JSON: ${{ secrets.PSIPHON_CONFIG_JSON }}

            - name: Build all platforms with embedded config
              run: make build-all-embedded PSIPHON_CONFIG=psiphon_config.json VERSION=${{ steps.version.outputs.VERSION }}

            - name: Remove Psiphon config from dist
              run: rm -f psiphon_config.json internal/config/psiphon_config.json

            - name: Create checksums
              run: |
                  cd dist
                  sha256sum conduit-* > checksums.txt
                  cat checksums.txt

            - name: Upload release artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: cli-dist
                  path: |
                      cli/dist/conduit-linux-amd64
                      cli/dist/conduit-linux-arm64
                      cli/dist/checksums.txt

            - name: Create Release
              uses: softprops/action-gh-release@v2
              if: github.ref_type == 'tag'
              with:
                  tag_name: ${{ steps.version.outputs.TAG_NAME }}
                  name: Conduit CLI ${{ steps.version.outputs.VERSION }}
                  draft: true
                  prerelease: true
                  files: |
                      cli/dist/conduit-linux-amd64
                      cli/dist/conduit-linux-arm64
                      cli/dist/conduit-darwin-amd64
                      cli/dist/conduit-darwin-arm64
                      cli/dist/conduit-windows-amd64.exe
                      cli/dist/conduit-freebsd-amd64
                      cli/dist/checksums.txt
                  body: |
                      ## Conduit CLI ${{ steps.version.outputs.VERSION }}

                      Conduit is a volunteer-run proxy node that helps relay traffic for users in censored regions.

                      ### Install on your PC

                      Download the binary for your platform:

                      | Platform        | File                          |
                      |-----------------|-------------------------------|
                      | Linux (amd64)   | `conduit-linux-amd64`         |
                      | Linux (arm64)   | `conduit-linux-arm64`        |
                      | macOS (Intel)   | `conduit-darwin-amd64`        |
                      | macOS (Apple Silicon) | `conduit-darwin-arm64` |
                      | Windows (amd64) | `conduit-windows-amd64.exe`   |
                      | FreeBSD (amd64) | `conduit-freebsd-amd64`      |

                      On Linux/macOS/FreeBSD: make it executable and optionally put it in your PATH:
                      ```bash
                      chmod +x conduit-*
                      # Optional: mv conduit-* /usr/local/bin/conduit
                      ```

                      Verify with `./conduit --help` (or `conduit --help` if in PATH).

                      ### Run Conduit on this machine

                      This binary includes an embedded configuration file, so you do not need to provide one:

                      ```bash
                      ./conduit start
                      ```

                      ### Provision other servers (Hetzner Cloud)

                      From your PC you can provision Conduit servers in the cloud. Run:

                      ```bash
                      ./conduit hetzner setup
                      ```

                      You will be prompted for a Hetzner API token (get one from [Hetzner Cloud Console](https://console.hetzner.cloud)), number of servers, server type (e.g. cx11), location, and Conduit options. Servers are created with Ubuntu; the Conduit CLI binary is installed from GitHub releases and run under systemd (no Docker). Each server runs Conduit automatically. Use this to run Conduit on one machine and set up more nodes from your desktop.

                      ### Docker

                      This release is also available as a Docker image (embedded config):

                      ```bash
                      docker pull ghcr.io/psiphon-inc/conduit/cli:latest
                      ```

                      ### Checksums and docs

                      Verify downloads with `checksums.txt`. For more details and options: https://github.com/Psiphon-Inc/conduit/blob/main/cli/README.md


    docker:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download release artifacts
              uses: actions/download-artifact@v4
              with:
                  name: cli-dist
                  path: cli/dist

            - name: Set version from tag
              id: version
              run: |
                  echo "VERSION=${GITHUB_REF_NAME#release-cli-}" >> $GITHUB_OUTPUT

            - name: Set image name
              id: image
              run: |
                  echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}/cli" >> $GITHUB_OUTPUT

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./cli
                  file: ./cli/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: |
                      ${{ steps.image.outputs.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
                      ${{ steps.image.outputs.IMAGE_NAME }}:latest
